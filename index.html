<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Pocket Tycoon – Idle Decisions (iPhone-safe)</title>
  <style>
    :root{
      --bg:#070a10; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
      --text:#eaf2ff; --muted:rgba(234,242,255,.75);
      --accent:#2f7cff; --accent2:#6a5cff; --danger:#ff3b3b; --good:#33d17a;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
    canvas{position:fixed;inset:0;width:100vw;height:100vh;z-index:0}
    .app{position:fixed;inset:0;z-index:1;display:flex;flex-direction:column}
    .topbar{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:12px 12px 10px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
    }
    .pill{display:flex;gap:10px;align-items:center;padding:8px 10px;border:1px solid var(--line);
      border-radius:999px;background:var(--panel)}
    .kpi{display:flex;flex-direction:column;line-height:1.1}
    .kpi b{font-size:14px}
    .kpi span{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px; padding:10px 12px; flex-wrap:wrap}
    .tab{border:1px solid var(--line); background:var(--panel); color:var(--text);
      padding:8px 10px; border-radius:12px; font-weight:800; font-size:13px}
    .tab.active{background:linear-gradient(135deg, rgba(47,124,255,.25), rgba(106,92,255,.18));
      border-color:rgba(47,124,255,.35)}
    .content{flex:1; overflow:auto; padding:0 12px 14px}
    .card{border:1px solid var(--line); background:var(--panel); border-radius:16px; padding:12px; margin:10px 0}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12px}
    .big{font-size:18px;font-weight:900}
    .btn{
      border:0; border-radius:12px; padding:10px 12px; font-weight:900;
      background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white;
    }
    .btn.ghost{background:transparent;border:1px solid var(--line); color:var(--text)}
    .btn.danger{background:linear-gradient(135deg,#ff3b3b,#ff7a3b)}
    .btn.good{background:linear-gradient(135deg,#33d17a,#2f7cff)}
    .btn:disabled{opacity:.45}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(0,0,0,.12)}
    .item h3{margin:0 0 6px 0;font-size:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr; gap:8px}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);font-size:12px;color:var(--muted)}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .bar > div{height:100%;background:linear-gradient(90deg,var(--good),var(--accent))}
    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      background:rgba(9,12,18,.86); border:1px solid var(--line);
      padding:10px 12px; border-radius:14px; display:none; z-index:9;
      max-width:min(520px, 92vw); color:var(--text); font-weight:800; font-size:13px;
    }
    input, textarea{
      width:100%; box-sizing:border-box; border-radius:12px; border:1px solid var(--line);
      background:rgba(0,0,0,.25); color:var(--text); padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>

  <div class="app">
    <div class="topbar">
      <div class="pill">
        <div class="kpi"><b id="money">£0</b><span>Cash</span></div>
        <div class="kpi"><b id="net">£0</b><span>Net Worth</span></div>
        <div class="kpi"><b id="rate">£0/s</b><span>Net income</span></div>
        <div class="kpi"><b id="qol">50</b><span>QoL</span></div>
      </div>
      <button class="btn ghost" id="saveBtn">Save</button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="overview">Overview</button>
      <button class="tab" data-tab="business">Businesses</button>
      <button class="tab" data-tab="lifestyle">Lifestyle</button>
      <button class="tab" data-tab="finance">Finance</button>
      <button class="tab" data-tab="reports">Reports</button>
    </div>

    <div class="content">
      <div id="tab-overview" class="tabpane"></div>
      <div id="tab-business" class="tabpane" style="display:none"></div>
      <div id="tab-lifestyle" class="tabpane" style="display:none"></div>
      <div id="tab-finance" class="tabpane" style="display:none"></div>
      <div id="tab-reports" class="tabpane" style="display:none"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ---------------------------
  // iPhone Safari Stability Kit
  // ---------------------------
  const KEY = "pocket_tycoon_ios_safe_v3";
  const SAVE_VERSION = 3;

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const saneNumber=(x, fallback=0)=> (typeof x==="number" && isFinite(x)) ? x : fallback;
  const now=()=>Date.now();

  const fmt = new Intl.NumberFormat(undefined,{notation:"compact",compactDisplay:"short",maximumFractionDigits:2});
  const moneyFmt = n => "£"+fmt.format(Math.max(0, saneNumber(n,0)));

  // ---------- Background (cached gradients; no leaks) ----------
  const bg = document.getElementById("bg");
  const bctx = bg.getContext("2d", { alpha:true });
  let W=innerWidth, H=innerHeight, DPR=1, stars=[];
  let g1=null, g2=null;

  function rebuildBackgroundCaches(){
    // cache gradients (do not recreate every frame)
    g1=bctx.createRadialGradient(W*0.25,H*0.3,10,W*0.25,H*0.3,Math.max(W,H)*0.8);
    g1.addColorStop(0,"rgba(47,124,255,0.10)"); g1.addColorStop(1,"rgba(0,0,0,0)");
    g2=bctx.createRadialGradient(W*0.8,H*0.65,10,W*0.8,H*0.65,Math.max(W,H)*0.85);
    g2.addColorStop(0,"rgba(106,92,255,0.08)"); g2.addColorStop(1,"rgba(0,0,0,0)");
  }

  function resize(){
    DPR = Math.max(1, Math.min(2, devicePixelRatio||1));
    W=innerWidth; H=innerHeight;
    bg.width=(W*DPR)|0; bg.height=(H*DPR)|0;
    bctx.setTransform(DPR,0,0,DPR,0,0);

    stars=[];
    for(let L=0; L<3; L++){
      const count=Math.floor((W*H)/(L===0?12000:L===1?17000:26000))+50;
      for(let i=0;i<count;i++){
        stars.push({
          x:Math.random()*W,y:Math.random()*H,
          r:(L===0?1.6:L===1?1.2:0.9)*(0.6+Math.random()),
          v:(L===0?22:L===1?12:7)*(0.7+Math.random()),
          a:(L===0?0.5:L===1?0.35:0.25)*(0.6+Math.random())
        });
      }
    }
    rebuildBackgroundCaches();
  }
  addEventListener("resize", resize, {passive:true});
  resize();

  function drawBG(dt){
    bctx.fillStyle="rgba(7,10,16,0.25)";
    bctx.fillRect(0,0,W,H);
    bctx.fillStyle=g1; bctx.fillRect(0,0,W,H);
    bctx.fillStyle=g2; bctx.fillRect(0,0,W,H);

    for(const s of stars){
      s.y += s.v*dt;
      if(s.y>H+10){s.y=-10; s.x=Math.random()*W;}
      bctx.globalAlpha=s.a;
      bctx.beginPath(); bctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      bctx.fillStyle="white"; bctx.fill();
    }
    bctx.globalAlpha=1;
  }

  // ---------- Toast ----------
  const toastEl=document.getElementById("toast");
  let toastT=0;
  function toast(msg){
    toastEl.textContent=msg;
    toastEl.style.display="block";
    toastT=3.5;
  }

  // ---------- Lifestyle catalog (realistic UK-ish prices; repeatable) ----------
  // maxOwned undefined => unlimited, but diminishing returns apply per repeated purchase
  const LIFESTYLE = [
    // Gadgets
    { id:"earbuds", type:"Gadget", name:"Wireless Earbuds", cost:129, upkeepPerSec:0, value:70, annualRate:-0.35, qol:+2, rep:+0, risk:+0 },
    { id:"phone",   type:"Gadget", name:"Smartphone (mid/high)", cost:799, upkeepPerSec:0, value:450, annualRate:-0.30, qol:+4, rep:+1, risk:+0, maxOwned:2 },
    { id:"laptop",  type:"Gadget", name:"Work Laptop", cost:1099, upkeepPerSec:0, value:650, annualRate:-0.28, qol:+5, rep:+2, risk:-1, maxOwned:2 },
    { id:"tablet",  type:"Gadget", name:"Tablet", cost:499, upkeepPerSec:0, value:280, annualRate:-0.28, qol:+3, rep:+1, risk:+0 },

    // Transport
    { id:"bike",    type:"Transport", name:"Bicycle", cost:350, upkeepPerSec:0.01, value:220, annualRate:-0.15, qol:+4, rep:+0, risk:-1, maxOwned:3 },
    { id:"scooter", type:"Transport", name:"Scooter", cost:850, upkeepPerSec:0.02, value:520, annualRate:-0.18, qol:+5, rep:+1, risk:+0, maxOwned:2 },
    { id:"usedcar", type:"Transport", name:"Used City Car", cost:6000, upkeepPerSec:0.12, value:4500, annualRate:-0.18, qol:+8, rep:+2, risk:+1, maxOwned:2 },
    { id:"sedan",   type:"Transport", name:"Reliable Sedan (used/new)", cost:20000, upkeepPerSec:0.28, value:16000, annualRate:-0.15, qol:+10, rep:+3, risk:+2, maxOwned:1 },
    { id:"luxcar",  type:"Transport", name:"Luxury Car", cost:80000, upkeepPerSec:0.70, value:64000, annualRate:-0.20, qol:+16, rep:+6, risk:+5, maxOwned:1 },

    // Homes (own one at a time; rent/subscriptions are recurring via upkeep)
    { id:"rentroom", type:"Home", name:"Rent a Room (monthly)", cost:0, upkeepPerSec:0.35, value:0, annualRate:0, qol:+6, rep:+1, risk:-2, cancelable:true, maxOwned:1 },
    { id:"studio",   type:"Home", name:"Studio Flat", cost:180000, upkeepPerSec:0.55, value:180000, annualRate:+0.03, qol:+14, rep:+4, risk:-2, maxOwned:1 },
    { id:"family",   type:"Home", name:"Family House", cost:350000, upkeepPerSec:0.80, value:350000, annualRate:+0.03, qol:+18, rep:+6, risk:-3, maxOwned:1 },

    // Living
    { id:"bed",   type:"Living", name:"Quality Bed & Mattress", cost:800, upkeepPerSec:0, value:250, annualRate:-0.35, qol:+6, rep:+0, risk:-1, maxOwned:2 },
    { id:"desk",  type:"Living", name:"Desk + Chair Setup", cost:450, upkeepPerSec:0, value:150, annualRate:-0.35, qol:+4, rep:+1, risk:-1, maxOwned:2 },
    { id:"sofa",  type:"Living", name:"Sofa", cost:900, upkeepPerSec:0, value:280, annualRate:-0.35, qol:+3, rep:+0, risk:+0, maxOwned:3 },

    // Style
    { id:"wardrobe", type:"Style", name:"Wardrobe Refresh", cost:300, upkeepPerSec:0, value:60, annualRate:-0.70, qol:+3, rep:+1, risk:+0 },
    { id:"watch",    type:"Style", name:"Classic Watch", cost:650, upkeepPerSec:0, value:350, annualRate:-0.12, qol:+2, rep:+3, risk:+0, maxOwned:3 },

    // Subscriptions (one of each)
    { id:"gym",      type:"Subscriptions", name:"Gym Membership", cost:0, upkeepPerSec:0.06, value:0, annualRate:0, qol:+6, rep:+1, risk:-2, cancelable:true, maxOwned:1 },
    { id:"stream",   type:"Subscriptions", name:"Streaming Sub", cost:0, upkeepPerSec:0.02, value:0, annualRate:0, qol:+2, rep:+0, risk:+0, cancelable:true, maxOwned:1 },
    { id:"phoneplan",type:"Subscriptions", name:"Phone Plan", cost:0, upkeepPerSec:0.03, value:0, annualRate:0, qol:+1, rep:+0, risk:+0, cancelable:true, maxOwned:1 },

    // Protection
    { id:"insure",   type:"Protection", name:"Insurance (health + liability)", cost:0, upkeepPerSec:0.12, value:0, annualRate:0, qol:+2, rep:+1, risk:-8, cancelable:true, maxOwned:1 },
    { id:"homealarm",type:"Protection", name:"Home Security System", cost:450, upkeepPerSec:0.02, value:120, annualRate:-0.25, qol:+1, rep:+0, risk:-5, maxOwned:2 },

    // Pets (repeatable within limits)
    { id:"cat", type:"Pets", name:"Adopt a Cat", cost:100, upkeepPerSec:0.05, value:0, annualRate:0, qol:+5, rep:+0, risk:-1, maxOwned:3 },
    { id:"dog", type:"Pets", name:"Adopt a Dog", cost:200, upkeepPerSec:0.08, value:0, annualRate:0, qol:+6, rep:+1, risk:-1, maxOwned:2 },

    // Experiences (repeatable consumables)
    { id:"holiday", type:"Experiences", name:"Weekend Trip", cost:300, upkeepPerSec:0, value:0, annualRate:0, qol:+6, rep:+0, risk:-1, consumable:true },
    { id:"concert", type:"Experiences", name:"Concert Night", cost:90, upkeepPerSec:0, value:0, annualRate:0, qol:+3, rep:+0, risk:+0, consumable:true },
  ];

  // ---------- Game State ----------
  const DEFAULT_STATE = () => ({
    v: SAVE_VERSION,
    money: 250,
    reputation: 50,
    risk: 40,
    qol: 50,
    policy:"balanced",
    lastSave: now(),
    lastBackgroundAt: now(),
    lastOfflineAwardAt: 0,
    totalEarned: 0,
    totalLost: 0,

    loans: [],

    // assets are instances (repeat buys)
    assets: [], // {instanceId, itemId, name, type, purchaseTime, value, upkeepPerSec, annualRate, qol, rep, risk, cancelable}

    businesses: [
      // scaled so realistic prices are reachable
      { id:"lemon", name:"Street Snacks", unlocked:true,  level:1, base:12.0, expense:4.0,  unlockCost:0,     risk:10, rep:2 },
      { id:"shop",  name:"Online Store",  unlocked:false, level:0, base:55.0, expense:22.0, unlockCost:1200,  risk:18, rep:4 },
      { id:"fleet", name:"Delivery Fleet",unlocked:false, level:0, base:180.0,expense:85.0, unlockCost:9000,  risk:28, rep:6 },
      { id:"studio",name:"Game Studio",   unlocked:false, level:0, base:520.0,expense:260.0,unlockCost:45000, risk:35, rep:10 },
    ],
    upgrades:{ analytics:0, security:0, pr:0, automation:0 }
  });

  let S = DEFAULT_STATE();

  function sanitiseState(){
    S.money = saneNumber(S.money, 0);
    S.totalEarned = saneNumber(S.totalEarned, 0);
    S.totalLost = saneNumber(S.totalLost, 0);
    S.reputation = clamp(saneNumber(S.reputation, 50), 0, 100);
    S.qol = clamp(saneNumber(S.qol, 50), 0, 100);
    S.risk = clamp(saneNumber(S.risk, 40), 0, 100);
    S.lastSave = saneNumber(S.lastSave, now());
    S.lastBackgroundAt = saneNumber(S.lastBackgroundAt, now());
    S.lastOfflineAwardAt = saneNumber(S.lastOfflineAwardAt, 0);
    S.policy = (S.policy==="conservative"||S.policy==="balanced"||S.policy==="aggressive") ? S.policy : "balanced";

    S.assets = Array.isArray(S.assets) ? S.assets : [];
    S.loans = Array.isArray(S.loans) ? S.loans : [];
    S.businesses = Array.isArray(S.businesses) ? S.businesses : DEFAULT_STATE().businesses;
    S.upgrades = S.upgrades && typeof S.upgrades==="object" ? S.upgrades : {analytics:0,security:0,pr:0,automation:0};

    // clean assets
    S.assets = S.assets.filter(a => a && typeof a==="object").map(a => ({
      instanceId: a.instanceId || ("A"+Math.random().toString(16).slice(2)),
      itemId: a.itemId || a.id || "unknown",
      name: a.name || "Item",
      type: a.type || "Other",
      purchaseTime: saneNumber(a.purchaseTime, now()),
      value: saneNumber(a.value, 0),
      upkeepPerSec: Math.max(0, saneNumber(a.upkeepPerSec, 0)),
      annualRate: saneNumber(a.annualRate, 0),
      qol: saneNumber(a.qol, 0),
      rep: saneNumber(a.rep, 0),
      risk: saneNumber(a.risk, 0),
      cancelable: !!a.cancelable
    }));

    // clean loans
    S.loans = S.loans.filter(L => L && typeof L==="object").map(L => ({
      id: L.id || ("L"+Math.random().toString(16).slice(2)),
      principal: Math.max(0, saneNumber(L.principal, 0)),
      rateAPR: Math.max(0, saneNumber(L.rateAPR, 0)),
      paymentPerSec: Math.max(0, saneNumber(L.paymentPerSec, 0)),
      remaining: Math.max(0, saneNumber(L.remaining, 0))
    }));
  }

  function safeReset(reason){
    localStorage.removeItem(KEY);
    S = DEFAULT_STATE();
    sanitiseState();
    toast(reason || "Save reset.");
    renderAll(true);
  }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const parsed = JSON.parse(raw);
      if(!parsed || parsed.v !== SAVE_VERSION){
        // version mismatch => reset
        safeReset("Save updated/reset (new version).");
        return;
      }
      S = parsed;
    }catch(e){
      safeReset("Save was corrupted and has been reset.");
    }finally{
      sanitiseState();
    }
  }

  function save(showToast=true){
    try{
      sanitiseState();
      S.lastSave = now();
      localStorage.setItem(KEY, JSON.stringify(S));
      if(showToast) toast("Saved.");
    }catch(e){
      // localStorage can fail if quota is hit
      toast("Save failed (storage issue). Consider Reset Save.");
    }
  }

  load();

  // ---------- Offline earnings (safe, single award, capped) ----------
  function assetUpkeepPerSec(){
    return S.assets.reduce((sum,a)=>sum + saneNumber(a.upkeepPerSec,0), 0);
  }
  function lifestyleEffects(){
    let rep=0, risk=0, qol=0;
    for(const a of S.assets){
      rep += saneNumber(a.rep,0);
      risk += saneNumber(a.risk,0);
      qol += saneNumber(a.qol,0);
    }
    return { rep, risk, qol };
  }
  function updateAssetValues(dt){
    const year = 365*24*3600;
    for(const a of S.assets){
      const rate = saneNumber(a.annualRate,0);
      if(!rate || a.value<=0) continue;
      const newVal = a.value * (1 + (rate/year)*dt);
      a.value = Math.max(0, saneNumber(newVal, a.value));
    }
  }

  function computeRates(){
    const policyIncomeMult = S.policy==="conservative" ? 0.90 : S.policy==="aggressive" ? 1.12 : 1.00;
    const policyRiskDelta  = S.policy==="conservative" ? -6 : S.policy==="aggressive" ? +10 : 0;

    const analyticsMult = 1 + 0.08*saneNumber(S.upgrades.analytics,0);
    const automationExpenseMult = 1 - 0.05*saneNumber(S.upgrades.automation,0);

    const life = lifestyleEffects();

    const qolIncomeMult = 0.92 + (S.qol/100)*0.16;
    const repIncomeMult = 0.85 + (S.reputation/100)*0.35;

    let income=0, expenses=0, baseRisk=0;
    for(const b of S.businesses){
      if(!b.unlocked || b.level<=0) continue;
      income += saneNumber(b.base,0) * saneNumber(b.level,0);
      expenses += saneNumber(b.expense,0) * saneNumber(b.level,0);
      baseRisk += saneNumber(b.risk,0) * Math.sqrt(Math.max(0, saneNumber(b.level,0)));
    }

    let loanPay=0;
    for(const L of S.loans) loanPay += saneNumber(L.paymentPerSec,0);

    const lifeUpkeep = assetUpkeepPerSec();

    income *= policyIncomeMult * analyticsMult * repIncomeMult * qolIncomeMult;
    expenses *= automationExpenseMult;

    let risk = baseRisk/10 + 20;
    risk += policyRiskDelta;
    risk -= 7*saneNumber(S.upgrades.security,0);
    risk += life.risk;
    risk -= (S.reputation-50)*0.08;
    risk = clamp(saneNumber(risk,40), 0, 100);

    const repDrift = (0.02*saneNumber(S.upgrades.pr,0)) + (S.qol>70 ? 0.01 : 0) - (risk>65 ? 0.015 : 0);

    const netPerSec = income - (expenses + loanPay + lifeUpkeep);
    return { incomePerSec:income, expensePerSec:(expenses+loanPay+lifeUpkeep), netPerSec, risk, repDrift };
  }

  function updateDerived(){
    const rates = computeRates();
    S.risk = rates.risk;

    const businessValue = S.businesses.reduce((sum,b)=>{
      if(!b.unlocked||b.level<=0) return sum;
      const approxNet = Math.max(0, (saneNumber(b.base,0) - saneNumber(b.expense,0)) * saneNumber(b.level,0));
      return sum + approxNet * 60 * 25;
    },0);

    const assetsValue = S.assets.reduce((s,a)=>s+saneNumber(a.value,0),0);
    const loanRemaining = S.loans.reduce((s,L)=>s+saneNumber(L.remaining,0),0);

    const netWorth = S.money + businessValue + assetsValue - loanRemaining;
    return { ...rates, businessValue, assetsValue, loanRemaining, netWorth };
  }

  function awardOffline(dtSeconds){
    dtSeconds = Math.max(0, Math.min(dtSeconds, 8*3600)); // cap at 8h
    if(dtSeconds < 2) return;

    const awardKey = Math.floor(now()/1000);
    if(S.lastOfflineAwardAt === awardKey) return; // prevent double-award in quick reopens
    S.lastOfflineAwardAt = awardKey;

    const { netPerSec } = computeRates();
    const gain = saneNumber(netPerSec,0) * dtSeconds;

    // prevent insane jumps (if something goes wrong)
    const cappedGain = clamp(gain, -5_000_000, 5_000_000);

    S.money += cappedGain;
    if(cappedGain>=0) S.totalEarned += cappedGain; else S.totalLost += -cappedGain;
    toast(`Offline: ${moneyFmt(cappedGain)} (${Math.round(dtSeconds/60)} min)`);
  }

  function onHidden(){
    S.lastBackgroundAt = now();
    save(false);
  }
  function onVisible(){
    const dt = (now() - saneNumber(S.lastBackgroundAt, now()))/1000;
    awardOffline(dt);
    S.lastBackgroundAt = now();
    sanitiseState();
    renderAll(true);
  }

  document.addEventListener("visibilitychange", () => {
    if(document.visibilityState === "hidden") onHidden();
    else onVisible();
  });

  // iOS Safari: pagehide/pageshow are more reliable than visibilitychange in some cases
  addEventListener("pagehide", onHidden);
  addEventListener("pageshow", (e) => { if(e.persisted) onVisible(); });

  // ---------- Loans ----------
  let loanId = 1;
  function takeLoan(amount, apr){
    amount = Math.max(0, amount);
    const paymentPerSec = (amount*(apr/100))/(365*24*3600) + (amount/(10*60));
    S.loans.push({ id:"L"+(loanId++), principal:amount, rateAPR:apr, paymentPerSec, remaining:amount });
    S.money += amount; S.totalEarned += amount;
    toast(`Loan: +${moneyFmt(amount)} (APR ${apr}%)`);
  }
  function tickLoans(dt){
    for(let i=S.loans.length-1;i>=0;i--){
      const L=S.loans[i];
      const pay = saneNumber(L.paymentPerSec,0)*dt;
      if(!isFinite(pay)) continue;
      S.money -= pay; S.totalLost += pay;
      L.remaining = Math.max(0, saneNumber(L.remaining,0) - (pay*0.92));
      if(L.remaining <= 0.01){
        toast(`Loan repaid (${L.id}).`);
        S.loans.splice(i,1);
      }
    }
  }

  // ---------- Business upgrades ----------
  function upgradeCost(b){
    const lvl = Math.max(0, saneNumber(b.level,0));
    return Math.floor(120 + (lvl*lvl) * (b.unlockCost? (b.unlockCost/26) : 40));
  }

  // ---------- UI ----------
  const moneyEl=document.getElementById("money");
  const netEl=document.getElementById("net");
  const rateEl=document.getElementById("rate");
  const qolEl=document.getElementById("qol");
  document.getElementById("saveBtn").onclick=()=>save(true);

  const tabOverview=document.getElementById("tab-overview");
  const tabBusiness=document.getElementById("tab-business");
  const tabLifestyle=document.getElementById("tab-lifestyle");
  const tabFinance=document.getElementById("tab-finance");
  const tabReports=document.getElementById("tab-reports");

  let currentTab="overview";
  function setTab(name){
    currentTab=name;
    for(const pane of document.querySelectorAll(".tabpane")) pane.style.display="none";
    for(const btn of document.querySelectorAll(".tab")) btn.classList.remove("active");
    document.querySelector(`.tab[data-tab="${name}"]`).classList.add("active");
    document.getElementById("tab-"+name).style.display="block";
    renderAll(true);
  }
  document.querySelectorAll(".tab").forEach(b=>b.onclick=()=>setTab(b.dataset.tab));

  // ---------- Export/Import ----------
  function exportSave(){
    sanitiseState();
    return JSON.stringify(S);
  }
  function importSave(text){
    try{
      const parsed = JSON.parse(text);
      if(!parsed || parsed.v !== SAVE_VERSION) throw new Error("Wrong save version");
      S = parsed;
      sanitiseState();
      save(false);
      toast("Save imported.");
      renderAll(true);
    }catch(e){
      toast("Import failed (invalid save).");
    }
  }

  // ---------- Rendering (only full render on demand) ----------
  function renderOverview(){
    const d=updateDerived();
    const repBar=Math.round(S.reputation);
    const riskBar=Math.round(S.risk);
    const qolBar=Math.round(S.qol);

    tabOverview.innerHTML=`
      <div class="card">
        <div class="row">
          <div>
            <div class="big">Overview</div>
            <div class="muted">On iPhone Safari, background tabs pause. This game uses offline progress when you return.</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn ghost" id="resetBtn">Reset Save</button>
            <button class="btn ghost" id="hardFixBtn">Fix Broken Save</button>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="grid3">
          <div class="item">
            <h3>Reputation</h3>
            <div class="bar"><div style="width:${repBar}%"></div></div>
            <div class="muted" style="margin-top:6px">${repBar}/100</div>
          </div>
          <div class="item">
            <h3>Risk</h3>
            <div class="bar"><div style="width:${riskBar}%;background:linear-gradient(90deg,var(--danger), #ffb86b)"></div></div>
            <div class="muted" style="margin-top:6px">${riskBar}/100</div>
          </div>
          <div class="item">
            <h3>Quality of Life</h3>
            <div class="bar"><div style="width:${qolBar}%;background:linear-gradient(90deg,var(--accent2), var(--good))"></div></div>
            <div class="muted" style="margin-top:6px">${qolBar}/100</div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="item">
          <div class="row">
            <div>
              <h3>Policy</h3>
              <div class="muted">Conservative = safer. Aggressive = faster growth but more incidents.</div>
            </div>
            <div class="grid3" style="min-width:260px">
              <button class="btn ${S.policy==="conservative"?"good":"ghost"}" id="polC">Conservative</button>
              <button class="btn ${S.policy==="balanced"?"good":"ghost"}" id="polB">Balanced</button>
              <button class="btn ${S.policy==="aggressive"?"good":"ghost"}" id="polA">Aggressive</button>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="item">
          <h3>Recovery tools</h3>
          <div class="muted">If the game ever “breaks” after hours, export your save, then reset, then import.</div>
          <div style="height:8px"></div>
          <button class="btn ghost" id="exportBtn">Export Save</button>
          <div style="height:8px"></div>
          <textarea id="saveBox" rows="6" placeholder="Exported save will appear here. Paste save here to import."></textarea>
          <div style="height:8px"></div>
          <button class="btn" id="importBtn">Import Save</button>
        </div>
      </div>
    `;

    document.getElementById("polC").onclick=()=>{S.policy="conservative"; save(false); renderAll(true);};
    document.getElementById("polB").onclick=()=>{S.policy="balanced"; save(false); renderAll(true);};
    document.getElementById("polA").onclick=()=>{S.policy="aggressive"; save(false); renderAll(true);};

    document.getElementById("resetBtn").onclick=()=>{
      if(!confirm("Reset your save? This deletes everything.")) return;
      safeReset("Save reset.");
    };
    document.getElementById("hardFixBtn").onclick=()=>{
      // if something goes wrong, sanitise + re-save
      sanitiseState(); save(false); toast("Save repaired."); renderAll(true);
    };
    document.getElementById("exportBtn").onclick=()=>{
      const txt = exportSave();
      document.getElementById("saveBox").value = txt;
      toast("Save exported (copy it).");
    };
    document.getElementById("importBtn").onclick=()=>{
      importSave(document.getElementById("saveBox").value.trim());
    };
  }

  function renderBusinesses(){
    const list = S.businesses.map(b=>{
      const locked=!b.unlocked;
      const lvl=Math.max(0, saneNumber(b.level,0));
      const canUnlock=locked && S.money>=b.unlockCost;
      const cost = upgradeCost(b);
      const canUpgrade=b.unlocked && S.money>=cost;
      const net = b.unlocked ? (saneNumber(b.base,0)-saneNumber(b.expense,0))*lvl : 0;
      return `
        <div class="item">
          <div class="row">
            <div>
              <h3>${b.name} ${b.unlocked?`<span class="badge">Level ${lvl}</span>`:`<span class="badge">Locked</span>`}</h3>
              <div class="muted">${b.unlocked
                ? `Income: ${moneyFmt(b.base)}/s • Expense: ${moneyFmt(b.expense)}/s • Net: ${moneyFmt(net)}/s`
                : `Unlock cost: ${moneyFmt(b.unlockCost)}`
              }</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              ${locked
                ? `<button class="btn ${canUnlock?"":"ghost"}" ${canUnlock?"":"disabled"} data-unlock="${b.id}">Unlock</button>`
                : `<button class="btn ${canUpgrade?"":"ghost"}" ${canUpgrade?"":"disabled"} data-up="${b.id}">Upgrade (${moneyFmt(cost)})</button>`
              }
            </div>
          </div>
        </div>
      `;
    }).join("");

    tabBusiness.innerHTML=`
      <div class="card">
        <div class="big">Businesses</div>
        <div class="muted">Unlock and upgrade income streams (scaled for realistic £ purchases).</div>
        <div style="height:10px"></div>
        <div class="list">${list}</div>
      </div>
    `;

    tabBusiness.querySelectorAll("[data-unlock]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-unlock");
        const b=S.businesses.find(x=>x.id===id);
        if(!b || b.unlocked || S.money<b.unlockCost) return;
        S.money-=b.unlockCost; S.totalLost+=b.unlockCost;
        b.unlocked=true; b.level=1;
        S.reputation=clamp(S.reputation+2,0,100);
        toast(`Unlocked: ${b.name}`);
        save(false); renderAll(true);
      };
    });

    tabBusiness.querySelectorAll("[data-up]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-up");
        const b=S.businesses.find(x=>x.id===id);
        const cost=upgradeCost(b);
        if(!b || !b.unlocked || S.money<cost) return;
        S.money-=cost; S.totalLost+=cost;
        b.level = Math.max(0, saneNumber(b.level,0)) + 1;
        toast(`${b.name} upgraded to Level ${b.level}`);
        save(false); renderAll(true);
      };
    });
  }

  function renderLifestyle(){
    const assetsValue = S.assets.reduce((s,a)=>s+saneNumber(a.value,0),0);
    const upkeep = assetUpkeepPerSec();

    // Owned section (instances)
    const ownedHtml = S.assets.length===0
      ? `<div class="muted">No lifestyle items yet. Buy items below.</div>`
      : S.assets.map(a=>{
          const resale = a.value>0 ? Math.floor(a.value * 0.70) : 0;
          const canSell = resale>0;
          const canCancel = !!a.cancelable && (a.upkeepPerSec||0) > 0;
          return `
            <div class="item">
              <div class="row">
                <div>
                  <h3>${a.name} <span class="badge">${a.type}</span></h3>
                  <div class="muted">
                    ${a.value>0?`Current value: <b>${moneyFmt(a.value)}</b> • `:""}
                    ${a.upkeepPerSec>0?`Upkeep: <b>${moneyFmt(a.upkeepPerSec)}/s</b>`:"No upkeep"}
                  </div>
                  <div class="muted">Effects: QoL ${a.qol>=0?`+${a.qol.toFixed(2)}`:a.qol.toFixed(2)} • Rep ${a.rep>=0?`+${a.rep.toFixed(2)}`:a.rep.toFixed(2)} • Risk ${a.risk>=0?`+${a.risk.toFixed(2)}`:a.risk.toFixed(2)}</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
                  ${canSell?`<button class="btn ghost" data-sell="${a.instanceId}">Sell (${moneyFmt(resale)})</button>`:""}
                  ${canCancel?`<button class="btn ghost" data-cancel="${a.instanceId}">Cancel</button>`:""}
                </div>
              </div>
            </div>
          `;
        }).join("");

    // Shop section grouped by type
    const groups = {};
    for(const it of LIFESTYLE) (groups[it.type] ||= []).push(it);

    const sections = Object.keys(groups).map(type=>{
      const rows = groups[type].map(it=>{
        const ownedCount = S.assets.filter(a => a.itemId === it.id).length;
        const cap = it.maxOwned ?? Infinity;
        const canBuy = (ownedCount < cap) && (S.money >= it.cost);

        const upkeepTxt = it.upkeepPerSec>0 ? ` • Upkeep: <b>${moneyFmt(it.upkeepPerSec)}/s</b>` : ``;
        const valueTxt = it.value>0 ? ` • Value: <b>${moneyFmt(it.value)}</b>` : ``;

        const tag = it.consumable
          ? `<span class="badge">Repeatable</span>`
          : `<span class="badge">Owned ${ownedCount}${isFinite(cap)?`/${cap}`:""}</span>`;

        return `
          <div class="item">
            <div class="row">
              <div>
                <h3>${it.name} ${tag}</h3>
                <div class="muted">Cost: <b>${moneyFmt(it.cost)}</b>${upkeepTxt}${valueTxt}</div>
                <div class="muted">Effects: QoL ${it.qol>=0?`+${it.qol}`:it.qol} • Rep ${it.rep>=0?`+${it.rep}`:it.rep} • Risk ${it.risk>=0?`+${it.risk}`:it.risk}</div>
                ${(!it.consumable && ownedCount>0) ? `<div class="muted">Diminishing returns apply on repeats.</div>` : ``}
              </div>
              <div>
                <button class="btn ${canBuy?"":"ghost"}" ${canBuy?"":"disabled"} data-buy="${it.id}">Buy</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      return `<div class="card"><div class="big">${type}</div><div class="list">${rows}</div></div>`;
    }).join("");

    tabLifestyle.innerHTML=`
      <div class="card">
        <div class="row">
          <div>
            <div class="big">Lifestyle</div>
            <div class="muted">Realistic £ pricing. Most items can be bought multiple times; some are capped (homes/subscriptions).</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Assets value</div>
            <div style="font-weight:900">${moneyFmt(assetsValue)}</div>
            <div class="muted">Upkeep</div>
            <div style="font-weight:900">${moneyFmt(upkeep)}/s</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="big">Owned</div>
        <div class="list">${ownedHtml}</div>
      </div>

      ${sections}
    `;

    // Buy
    tabLifestyle.querySelectorAll("[data-buy]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-buy");
        const it=LIFESTYLE.find(x=>x.id===id);
        if(!it) return;

        const ownedCount = S.assets.filter(a => a.itemId === it.id).length;
        const cap = it.maxOwned ?? Infinity;
        if(ownedCount >= cap) return toast("You can’t own more of this item.");
        if(S.money < it.cost) return toast("Not enough cash.");

        // Pay
        S.money -= it.cost; S.totalLost += it.cost;

        // Consumables: apply full effect each time (small boosts)
        if(it.consumable){
          S.qol = clamp(S.qol + saneNumber(it.qol,0), 0, 100);
          S.reputation = clamp(S.reputation + saneNumber(it.rep,0), 0, 100);
          S.risk = clamp(S.risk + saneNumber(it.risk,0), 0, 100);
          toast(`Purchased: ${it.name}`);
          save(false); renderAll(true);
          return;
        }

        // Diminishing returns for repeat purchases:
        // first = 1.00, second = 0.65, third = 0.42 ...
        const mult = Math.pow(0.65, ownedCount);

        const effQol  = saneNumber(it.qol,0) * mult;
        const effRep  = saneNumber(it.rep,0) * mult;
        const effRisk = saneNumber(it.risk,0) * mult;

        const instanceId = "A"+Math.random().toString(16).slice(2);

        S.assets.push({
          instanceId,
          itemId: it.id,
          name: it.name,
          type: it.type,
          purchaseTime: now(),
          value: saneNumber(it.value,0),
          upkeepPerSec: Math.max(0, saneNumber(it.upkeepPerSec,0)),
          annualRate: saneNumber(it.annualRate,0),
          qol: effQol, rep: effRep, risk: effRisk,
          cancelable: !!it.cancelable
        });

        S.qol = clamp(S.qol + effQol, 0, 100);
        S.reputation = clamp(S.reputation + effRep, 0, 100);
        S.risk = clamp(S.risk + effRisk, 0, 100);

        toast(`Purchased: ${it.name}`);
        save(false); renderAll(true);
      };
    });

    // Sell
    tabLifestyle.querySelectorAll("[data-sell]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-sell");
        const idx=S.assets.findIndex(a=>a.instanceId===id);
        if(idx<0) return;
        const a=S.assets[idx];
        const payout = Math.floor(saneNumber(a.value,0) * 0.70);
        if(payout <= 0) return;

        S.money += payout; S.totalEarned += payout;

        S.qol = clamp(S.qol - saneNumber(a.qol,0), 0, 100);
        S.reputation = clamp(S.reputation - saneNumber(a.rep,0), 0, 100);
        S.risk = clamp(S.risk - saneNumber(a.risk,0), 0, 100);

        S.assets.splice(idx,1);
        toast(`Sold: ${a.name} (+${moneyFmt(payout)})`);
        save(false); renderAll(true);
      };
    });

    // Cancel (remove subscription/rent and reverse its effects)
    tabLifestyle.querySelectorAll("[data-cancel]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-cancel");
        const idx=S.assets.findIndex(a=>a.instanceId===id);
        if(idx<0) return;
        const a=S.assets[idx];

        S.qol = clamp(S.qol - saneNumber(a.qol,0), 0, 100);
        S.reputation = clamp(S.reputation - saneNumber(a.rep,0), 0, 100);
        S.risk = clamp(S.risk - saneNumber(a.risk,0), 0, 100);

        S.assets.splice(idx,1);
        toast(`Canceled: ${a.name}`);
        save(false); renderAll(true);
      };
    });
  }

  function renderFinance(){
    const loanHtml = S.loans.length===0 ? `<div class="muted">No active loans.</div>` : S.loans.map(L=>`
      <div class="item">
        <h3>Loan ${L.id}</h3>
        <div class="muted">APR ${L.rateAPR}% • Remaining ${moneyFmt(L.remaining)} • Payment ${moneyFmt(L.paymentPerSec)}/s</div>
      </div>`).join("");

    tabFinance.innerHTML=`
      <div class="card">
        <div class="big">Finance</div>
        <div class="muted">Loans accelerate growth, but debt reduces net income.</div>
        <div style="height:10px"></div>
        <div class="grid2">
          <div class="item">
            <h3>Small loan</h3>
            <div class="muted">Good early acceleration.</div>
            <div style="height:8px"></div>
            <button class="btn" id="loan1">Borrow ${moneyFmt(5000)} (APR 16%)</button>
          </div>
          <div class="item">
            <h3>Growth loan</h3>
            <div class="muted">Bigger jump; higher pressure.</div>
            <div style="height:8px"></div>
            <button class="btn danger" id="loan2">Borrow ${moneyFmt(25000)} (APR 26%)</button>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="item">
          <h3>Active loans</h3>
          ${loanHtml}
        </div>
      </div>
    `;

    document.getElementById("loan1").onclick=()=>{
      if(S.loans.length>=3) return toast("Too many active loans.");
      takeLoan(5000,16); save(false); renderAll(true);
    };
    document.getElementById("loan2").onclick=()=>{
      if(S.loans.length>=3) return toast("Too many active loans.");
      S.risk = clamp(S.risk + 6, 0, 100);
      takeLoan(25000,26); save(false); renderAll(true);
    };
  }

  function renderReports(){
    const d=updateDerived();
    tabReports.innerHTML=`
      <div class="card">
        <div class="big">Reports</div>
        <div class="muted">Wealth breakdown and net income drivers.</div>
        <div style="height:10px"></div>
        <div class="grid2">
          <div class="item">
            <h3>Totals</h3>
            <div class="muted">Earned: <b>${moneyFmt(S.totalEarned)}</b></div>
            <div class="muted">Lost: <b>${moneyFmt(S.totalLost)}</b></div>
          </div>
          <div class="item">
            <h3>Net worth</h3>
            <div class="muted">Business value: <b>${moneyFmt(d.businessValue)}</b></div>
            <div class="muted">Assets value: <b>${moneyFmt(d.assetsValue)}</b></div>
            <div class="muted">Loan remaining: <b>${moneyFmt(d.loanRemaining)}</b></div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="item">
          <h3>Rates</h3>
          <div class="muted">Income: <b>${moneyFmt(d.incomePerSec)}/s</b></div>
          <div class="muted">Expenses+Debt+Upkeep: <b>${moneyFmt(d.expensePerSec)}/s</b></div>
          <div class="muted">Net: <b>${moneyFmt(d.netPerSec)}/s</b></div>
        </div>
      </div>
    `;
  }

  function renderAll(force){
    // only render the active tab pane (reduces DOM churn)
    const d=updateDerived();
    moneyEl.textContent = moneyFmt(S.money);
    netEl.textContent = moneyFmt(d.netWorth);
    rateEl.textContent = `${moneyFmt(d.netPerSec)}/s`;
    qolEl.textContent = String(Math.round(S.qol));

    if(currentTab==="overview") renderOverview();
    else if(currentTab==="business") renderBusinesses();
    else if(currentTab==="lifestyle") renderLifestyle();
    else if(currentTab==="finance") renderFinance();
    else if(currentTab==="reports") renderReports();
  }

  // ---------- Start on Overview ----------
  renderAll(true);

  // ---------- Main loop (stable; no full rerender) ----------
  let last=performance.now();
  function loop(t){
    const dt=Math.min(0.05,(t-last)/1000);
    last=t;

    drawBG(dt);
    updateAssetValues(dt);

    const r = computeRates();
    const delta = saneNumber(r.netPerSec,0) * dt;
    S.money += delta;
    if(delta>=0) S.totalEarned += delta; else S.totalLost += -delta;

    // reputation drift
    S.reputation = clamp(S.reputation + saneNumber(r.repDrift,0)*dt*60, 0, 100);

    // QoL drift: too much upkeep with low cash causes stress
    const upkeep = assetUpkeepPerSec();
    if(upkeep > saneNumber(r.incomePerSec,0)*0.45 && S.money < 500){
      S.qol = clamp(S.qol - 0.8*dt, 0, 100);
    } else {
      S.qol = clamp(S.qol + 0.08*dt, 0, 100);
    }

    tickLoans(dt);

    // autosave every 20s
    if(now()-S.lastSave > 20000) save(false);

    // toast fade
    if(toastT>0){ toastT-=dt; if(toastT<=0) toastEl.style.display="none"; }

    // update KPIs only (cheap)
    const d=updateDerived();
    moneyEl.textContent = moneyFmt(S.money);
    netEl.textContent = moneyFmt(d.netWorth);
    rateEl.textContent = `${moneyFmt(d.netPerSec)}/s`;
    qolEl.textContent = String(Math.round(S.qol));

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
